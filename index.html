<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë…„í‡´ì§ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .input-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        input[type="text"], input[type="date"], input[type="file"] {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="file"]:focus {
            border-color: #3498db;
            outline: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        .employee-list, .yearly-summary {
            background: white;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            overflow: hidden;
        }
        .section-header {
            background: #34495e;
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
        }
        .employee-item, .year-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s;
        }
        .employee-item:hover, .year-item:hover {
            background: #f8f9fa;
        }
        .employee-item:last-child, .year-item:last-child {
            border-bottom: none;
        }
        .employee-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        .retirement-info {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .year-header {
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .year-employees {
            margin-left: 15px;
        }
        .year-employee {
            margin: 5px 0;
            padding: 5px 0;
        }
        .urgent {
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
        }
        .soon {
            background: #fff8e1;
            border-left: 4px solid #f39c12;
        }
        .normal {
            background: #f0f9ff;
            border-left: 4px solid #3498db;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        .preview-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .preview-header {
            background: #34495e;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preview-header h3 {
            margin: 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .preview-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .preview-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì •ë…„í‡´ì§ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
            ê·¼ë¡œê¸°ì¤€ë²• ì œ19ì¡°ì— ë”°ë¥¸ ë²•ì • ì •ë…„ 60ì„¸ ê¸°ì¤€<br>
            <small style="color: #95a5a6;">* ì •ë…„í‡´ì§ì¼: ìƒì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼</small>
        </p>
        
        <div style="text-align: center; margin-bottom: 20px; font-size: 12px; color: #95a5a6;">
            Â© 2025 Sungrak Church Office. All rights reserved.
        </div>
        
        <div class="input-section">
            <h3>ì§ì› ì •ë³´ ì…ë ¥</h3>
            <div class="form-row">
                <input type="text" id="employeeName" placeholder="ì§ì› ì´ë¦„" />
                <input type="text" id="socialNumber" placeholder="ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬ (YYMMDD)" maxlength="6" />
                <input type="date" id="birthDate" placeholder="ë˜ëŠ” ìƒë…„ì›”ì¼ ì§ì ‘ ì…ë ¥" />
                <button onclick="addEmployee()">ì¶”ê°€</button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                * ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬ ì…ë ¥ ì‹œ ìƒë…„ì›”ì¼ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤ (ì˜ˆ: 640315 â†’ 1964-03-15)
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #bdc3c7;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">ì—‘ì…€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</h4>
                <div class="form-row">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="flex: 2;" />
                    <button onclick="importExcel()">íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
                    <button onclick="downloadTemplate()" style="background: #27ae60;">í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                    * ì—‘ì…€ íŒŒì¼ í˜•ì‹: Aì—´(ì´ë¦„), Bì—´(ìƒë…„ì›”ì¼ ë˜ëŠ” ì£¼ë¯¼ë²ˆí˜¸) | ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›: YYYY-MM-DD, ì£¼ë¯¼ë²ˆí˜¸ 13ìë¦¬, ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬
                </div>
            </div>
        </div>

        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">ì´ ì§ì› ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="thisYearRetirement">0</div>
                <div class="stat-label">ì˜¬í•´ ì •ë…„í‡´ì§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="nextYearRetirement">0</div>
                <div class="stat-label">ë‚´ë…„ ì •ë…„í‡´ì§</div>
            </div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <div class="export-section">
                <h3 style="margin-top: 0; color: #2c3e50;">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                <div class="form-row">
                    <button onclick="previewExport('all')" style="background: #27ae60;">ì „ì²´ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</button>
                    <button onclick="previewExport('thisYear')" style="background: #e74c3c;">ì˜¬í•´ ì •ë…„í‡´ì§ì ë¯¸ë¦¬ë³´ê¸°</button>
                    <button onclick="previewExport('nextYear')" style="background: #f39c12;">ë‚´ë…„ ì •ë…„í‡´ì§ì ë¯¸ë¦¬ë³´ê¸°</button>
                    <button onclick="previewYearlySummary()" style="background: #9b59b6;">ì—°ë„ë³„ ì¸ì› ë¯¸ë¦¬ë³´ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
        <div class="preview-modal" id="previewModal">
            <div class="preview-content">
                <div class="preview-header">
                    <h3 id="previewTitle">ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                    <button class="close-btn" onclick="closePreview()">&times;</button>
                </div>
                <div class="preview-body" id="previewBody">
                    <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="preview-footer">
                    <button onclick="closePreview()" style="background: #95a5a6;">ì·¨ì†Œ</button>
                    <button id="downloadBtn" onclick="confirmDownload()" style="background: #27ae60;">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
        </div>

        <div class="results" id="resultsSection" style="display: none;">
            <div class="employee-list">
                <div class="section-header">ì§ì›ë³„ ì •ë…„í‡´ì§ ì •ë³´</div>
                <div id="employeeResults"></div>
            </div>
            
            <div class="yearly-summary">
                <div class="section-header">ì—°ë„ë³„ ì •ë…„í‡´ì§ ì˜ˆì •ì</div>
                <div id="yearlyResults"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let employees = [];
        const RETIREMENT_AGE = 60;
        
        function parseVariousDateFormats(input) {
            if (!input) return null;
            
            const inputStr = String(input).trim();
            
            // 1. ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (dateRegex.test(inputStr)) {
                const testDate = new Date(inputStr);
                if (!isNaN(testDate.getTime())) {
                    return inputStr;
                }
            }
            
            // 2. ì£¼ë¯¼ë²ˆí˜¸ 13ìë¦¬ (123456-1234567 ë˜ëŠ” 1234561234567)
            const fullSocialRegex = /^(\d{6})[-]?\d{7}$/;
            const fullSocialMatch = inputStr.match(fullSocialRegex);
            if (fullSocialMatch) {
                return parseSocialNumber(fullSocialMatch[1]);
            }
            
            // 3. ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬ë§Œ (123456)
            const shortSocialRegex = /^\d{6}$/;
            if (shortSocialRegex.test(inputStr)) {
                return parseSocialNumber(inputStr);
            }
            
            // 4. ì—‘ì…€ ì‹œë¦¬ì–¼ ë‚ ì§œ (ìˆ«ì)
            if (typeof input === 'number' && input > 0) {
                const excelEpoch = new Date(1900, 0, 1);
                const birth = new Date(excelEpoch.getTime() + (input - 2) * 86400000);
                if (!isNaN(birth.getTime())) {
                    return birth.toISOString().split('T')[0];
                }
            }
            
            // 5. Date ê°ì²´ì¸ ê²½ìš°
            if (input instanceof Date && !isNaN(input.getTime())) {
                return input.toISOString().split('T')[0];
            }
            
            return null;
        }
        
        function parseSocialNumber(socialNumber) {
            if (!socialNumber || socialNumber.length !== 6) {
                return null;
            }
            
            // ìˆ«ìë§Œ ìˆëŠ”ì§€ í™•ì¸
            if (!/^\d{6}$/.test(socialNumber)) {
                return null;
            }
            
            const year = parseInt(socialNumber.substring(0, 2));
            const month = parseInt(socialNumber.substring(2, 4));
            const day = parseInt(socialNumber.substring(4, 6));
            
            // ì›”ê³¼ ì¼ ìœ íš¨ì„± ê²€ì‚¬
            if (month < 1 || month > 12 || day < 1 || day > 31) {
                return null;
            }
            
            // ë…„ë„ ê³„ì‚° (ì¼ë°˜ì ìœ¼ë¡œ 00-30ì€ 2000ë…„ëŒ€, 31-99ëŠ” 1900ë…„ëŒ€ë¡œ ì²˜ë¦¬)
            let fullYear;
            if (year <= 30) {
                fullYear = 2000 + year;
            } else {
                fullYear = 1900 + year;
            }
            
            // ë‚ ì§œ ìœ íš¨ì„± ìµœì¢… ê²€ì‚¬
            const testDate = new Date(fullYear, month - 1, day);
            if (testDate.getFullYear() !== fullYear || 
                testDate.getMonth() !== month - 1 || 
                testDate.getDate() !== day) {
                return null;
            }
            
            return `${fullYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
        
        function calculateRetirementDate(birthDate) {
            const retirement = new Date(birthDate);
            retirement.setFullYear(retirement.getFullYear() + RETIREMENT_AGE);
            
            // ìƒì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼ë¡œ ì„¤ì •
            const year = retirement.getFullYear();
            const month = retirement.getMonth();
            
            // ë‹¤ìŒ ë‹¬ì˜ ì²«ì§¸ ë‚ ì—ì„œ í•˜ë£¨ë¥¼ ë¹¼ë©´ í˜„ì¬ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ 
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            return lastDayOfMonth;
        }
        
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const socialNumber = document.getElementById('socialNumber').value.trim();
            let birthDate = document.getElementById('birthDate').value;
            
            if (!name) {
                alert('ì§ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì£¼ë¯¼ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš° ìƒë…„ì›”ì¼ ìë™ ê³„ì‚°
            if (socialNumber) {
                const parsedBirthDate = parseSocialNumber(socialNumber);
                if (!parsedBirthDate) {
                    alert('ì˜¬ë°”ë¥¸ ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 640315)');
                    return;
                }
                birthDate = parsedBirthDate;
                // ê³„ì‚°ëœ ìƒë…„ì›”ì¼ì„ í™”ë©´ì— í‘œì‹œ
                document.getElementById('birthDate').value = birthDate;
            }
            
            if (!birthDate) {
                alert('ì£¼ë¯¼ë²ˆí˜¸ ì• 6ìë¦¬ ë˜ëŠ” ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¤‘ë³µ í™•ì¸
            if (employees.some(emp => emp.name === name && emp.birthDate === birthDate)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ì§ì›ì…ë‹ˆë‹¤.');
                return;
            }
            
            const birth = new Date(birthDate);
            const retirementDate = calculateRetirementDate(birth);
            
            employees.push({
                name: name,
                birthDate: birthDate,
                birth: birth,
                retirementDate: retirementDate,
                retirementYear: retirementDate.getFullYear()
            });
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('employeeName').value = '';
            document.getElementById('socialNumber').value = '';
            document.getElementById('birthDate').value = '';
            
            updateDisplay();
        }
        
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let importCount = 0;
                    let skipCount = 0;
                    let errorCount = 0;
                    
                    // ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ë¡œ ê±´ë„ˆë›°ê¸°
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0] || !row[1]) continue; // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°
                        
                        const name = String(row[0]).trim();
                        const dateInput = row[1];
                        
                        // ë‹¤ì–‘í•œ í˜•ì‹ì˜ ë‚ ì§œ/ì£¼ë¯¼ë²ˆí˜¸ ì²˜ë¦¬
                        const birthDateStr = parseVariousDateFormats(dateInput);
                        
                        if (!birthDateStr) {
                            console.error(`ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨: ${name} - ${dateInput}`);
                            errorCount++;
                            continue;
                        }
                        
                        // ì¤‘ë³µ í™•ì¸
                        if (employees.some(emp => emp.name === name && emp.birthDate === birthDateStr)) {
                            skipCount++;
                            continue;
                        }
                        
                        // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
                        const birth = new Date(birthDateStr);
                        if (isNaN(birth.getTime())) {
                            errorCount++;
                            continue;
                        }
                        
                        const retirementDate = calculateRetirementDate(birth);
                        
                        employees.push({
                            name: name,
                            birthDate: birthDateStr,
                            birth: birth,
                            retirementDate: retirementDate,
                            retirementYear: retirementDate.getFullYear()
                        });
                        
                        importCount++;
                    }
                    
                    // ê²°ê³¼ ë©”ì‹œì§€
                    let message = `ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!\n`;
                    message += `- ì‹ ê·œ ë“±ë¡: ${importCount}ëª…\n`;
                    if (skipCount > 0) message += `- ì¤‘ë³µ ê±´ë„ˆë›°ê¸°: ${skipCount}ëª…\n`;
                    if (errorCount > 0) message += `- ì˜¤ë¥˜ ê±´ë„ˆë›°ê¸°: ${errorCount}ëª…\n`;
                    
                    alert(message);
                    
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    fileInput.value = '';
                    
                    updateDisplay();
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function downloadTemplate() {
            // í…œí”Œë¦¿ ë°ì´í„° ìƒì„±
            const templateData = [
                ['ì´ë¦„', 'ìƒë…„ì›”ì¼ ë˜ëŠ” ì£¼ë¯¼ë²ˆí˜¸'],
                ['í™ê¸¸ë™', '1964-03-15'],
                ['ê¹€ì² ìˆ˜', '650722-1234567'],
                ['ì´ì˜í¬', '661203'],
                ['ë°•ë¯¼ìˆ˜', '1975-08-10']
            ];
            
            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                {wch: 15}, // ì´ë¦„ ì—´
                {wch: 20}  // ìƒë…„ì›”ì¼/ì£¼ë¯¼ë²ˆí˜¸ ì—´
            ];
            
            // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš© (ê°„ë‹¨í•œ ë°©ë²•)
            XLSX.utils.book_append_sheet(wb, ws, 'ì§ì›ì •ë³´');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, 'ì§ì›ì •ë³´_í…œí”Œë¦¿.xlsx');
        }
        
        let currentExportData = null;
        let currentExportType = null;
        let currentFileName = '';
        
        function previewExport(type) {
            if (employees.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let filteredEmployees = [];
            let title = '';
            const currentYear = new Date().getFullYear();
            
            switch(type) {
                case 'all':
                    filteredEmployees = [...employees];
                    title = 'ì „ì²´ ì§ì› ì •ë…„í‡´ì§ ì •ë³´';
                    currentFileName = 'ì „ì²´_ì§ì›_ì •ë…„í‡´ì§_ì •ë³´';
                    break;
                case 'thisYear':
                    filteredEmployees = employees.filter(emp => emp.retirementYear === currentYear);
                    title = `${currentYear}ë…„ ì •ë…„í‡´ì§ ì˜ˆì •ì`;
                    currentFileName = `${currentYear}ë…„_ì •ë…„í‡´ì§_ì˜ˆì •ì`;
                    break;
                case 'nextYear':
                    filteredEmployees = employees.filter(emp => emp.retirementYear === currentYear + 1);
                    title = `${currentYear + 1}ë…„ ì •ë…„í‡´ì§ ì˜ˆì •ì`;
                    currentFileName = `${currentYear + 1}ë…„_ì •ë…„í‡´ì§_ì˜ˆì •ì`;
                    break;
            }
            
            if (filteredEmployees.length === 0) {
                alert('í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì •ë…„í‡´ì§ì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            filteredEmployees.sort((a, b) => a.retirementDate - b.retirementDate);
            
            // ì—‘ì…€ ë°ì´í„° êµ¬ì„±
            const excelData = [
                ['ì´ë¦„', 'ìƒë…„ì›”ì¼', 'í˜„ì¬ë‚˜ì´', 'ì •ë…„í‡´ì§ì¼', 'ì •ë…„í‡´ì§ë…„ë„', 'ë‚¨ì€ì¼ìˆ˜']
            ];
            
            const today = new Date();
            filteredEmployees.forEach(emp => {
                const age = today.getFullYear() - emp.birth.getFullYear();
                const remainingDays = Math.ceil((emp.retirementDate - today) / (1000 * 60 * 60 * 24));
                
                excelData.push([
                    emp.name,
                    emp.birthDate,
                    age + 'ì„¸',
                    emp.retirementDate.toISOString().split('T')[0],
                    emp.retirementYear,
                    remainingDays > 0 ? remainingDays + 'ì¼' : 'í‡´ì§ì™„ë£Œ'
                ]);
            });
            
            currentExportData = excelData;
            currentExportType = 'normal';
            showPreview(title, excelData);
        }
        
        function previewYearlySummary() {
            if (employees.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
            const yearGroups = {};
            employees.forEach(emp => {
                const year = emp.retirementYear;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(emp);
            });
            
            const sortedYears = Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b));
            
            // ì—°ë„ë³„ ì¸ì› ë°ì´í„° êµ¬ì„±
            const summaryData = [
                ['ì •ë…„í‡´ì§ë…„ë„', 'í‡´ì§ì˜ˆì •ì¸ì›']
            ];
            
            sortedYears.forEach(year => {
                const count = yearGroups[year].length;
                summaryData.push([year + 'ë…„', count + 'ëª…']);
            });
            
            currentExportData = { summaryData, yearGroups, sortedYears };
            currentExportType = 'summary';
            currentFileName = 'ì—°ë„ë³„_ì •ë…„í‡´ì§_ì¸ì›';
            showPreview('ì—°ë„ë³„ ì •ë…„í‡´ì§ ì¸ì›', summaryData);
        }
        
        function showPreview(title, data) {
            document.getElementById('previewTitle').textContent = title + ' ë¯¸ë¦¬ë³´ê¸°';
            
            let html = `
                <div style="margin-bottom: 15px; color: #7f8c8d;">
                    ì´ ${data.length - 1}ê±´ì˜ ë°ì´í„° (ì œëª©í–‰ ì œì™¸)
                </div>
                <table class="preview-table">
            `;
            
            data.forEach((row, index) => {
                html += '<tr>';
                row.forEach(cell => {
                    const tag = index === 0 ? 'th' : 'td';
                    html += `<${tag}>${cell}</${tag}>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            if (currentExportType === 'summary') {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px;">
                        <strong>ğŸ’¡ ì°¸ê³ ì‚¬í•­:</strong><br>
                        ì—°ë„ë³„ ì¸ì› ë‹¤ìš´ë¡œë“œ ì‹œ ìœ„ ìš”ì•½í‘œì™€ í•¨ê»˜ ê° ì—°ë„ë³„ ìƒì„¸ ì‹œíŠ¸ê°€ í¬í•¨ë©ë‹ˆë‹¤.
                    </div>
                `;
            }
            
            document.getElementById('previewBody').innerHTML = html;
            document.getElementById('previewModal').style.display = 'block';
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            currentExportData = null;
            currentExportType = null;
            currentFileName = '';
        }
        
        function confirmDownload() {
            if (!currentExportData || !currentExportType) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (currentExportType === 'normal') {
                downloadNormalExcel();
            } else if (currentExportType === 'summary') {
                downloadSummaryExcel();
            }
            
            closePreview();
        }
        
        function downloadNormalExcel() {
            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(currentExportData);
            
            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                {wch: 12}, // ì´ë¦„
                {wch: 12}, // ìƒë…„ì›”ì¼
                {wch: 10}, // í˜„ì¬ë‚˜ì´
                {wch: 12}, // ì •ë…„í‡´ì§ì¼
                {wch: 12}, // ì •ë…„í‡´ì§ë…„ë„
                {wch: 10}  // ë‚¨ì€ì¼ìˆ˜
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ì •ë…„í‡´ì§ì •ë³´');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `${currentFileName}_${timestamp}.xlsx`);
        }
        
        function downloadSummaryExcel() {
            const { summaryData, yearGroups, sortedYears } = currentExportData;
            
            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            
            // ìš”ì•½ ì‹œíŠ¸ ìƒì„±
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{wch: 15}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'ì—°ë„ë³„ì¸ì›');
            
            // ê° ì—°ë„ë³„ ìƒì„¸ ì‹œíŠ¸ ìƒì„±
            sortedYears.forEach(year => {
                const yearEmployees = yearGroups[year].sort((a, b) => a.retirementDate - b.retirementDate);
                const yearData = [
                    ['ì´ë¦„', 'ìƒë…„ì›”ì¼', 'ì •ë…„í‡´ì§ì¼', 'í˜„ì¬ë‚˜ì´']
                ];
                
                const today = new Date();
                yearEmployees.forEach(emp => {
                    const age = today.getFullYear() - emp.birth.getFullYear();
                    yearData.push([
                        emp.name,
                        emp.birthDate,
                        emp.retirementDate.toISOString().split('T')[0],
                        age + 'ì„¸'
                    ]);
                });
                
                const yearWs = XLSX.utils.aoa_to_sheet(yearData);
                yearWs['!cols'] = [{wch: 12}, {wch: 12}, {wch: 12}, {wch: 10}];
                XLSX.utils.book_append_sheet(wb, yearWs, year + 'ë…„');
            });
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `${currentFileName}_${timestamp}.xlsx`);
        }
        function exportToExcel(type) {
            // ê¸°ì¡´ í•¨ìˆ˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤
            // í˜¸í™˜ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤
            previewExport(type);
        }
        
        function exportYearlySummary() {
            // ê¸°ì¡´ í•¨ìˆ˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤
            // í˜¸í™˜ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤
            previewYearlySummary();
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function getUrgencyClass(retirementDate) {
            const today = new Date();
            const daysDiff = Math.ceil((retirementDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 365) return 'urgent';
            if (daysDiff <= 730) return 'soon';
            return 'normal';
        }
        
        function updateDisplay() {
            if (employees.length === 0) {
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
                return;
            }
            
            document.getElementById('resultsSection').style.display = 'grid';
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('exportSection').style.display = 'block';
            
            updateStats();
            updateEmployeeList();
            updateYearlySummary();
        }
        
        function updateStats() {
            const currentYear = new Date().getFullYear();
            const thisYear = employees.filter(emp => emp.retirementYear === currentYear).length;
            const nextYear = employees.filter(emp => emp.retirementYear === currentYear + 1).length;
            
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('thisYearRetirement').textContent = thisYear;
            document.getElementById('nextYearRetirement').textContent = nextYear;
        }
        
        function updateEmployeeList() {
            const container = document.getElementById('employeeResults');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì •ë…„í‡´ì§ì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            const sortedEmployees = [...employees].sort((a, b) => a.retirementDate - b.retirementDate);
            
            container.innerHTML = sortedEmployees.map(emp => {
                const age = new Date().getFullYear() - emp.birth.getFullYear();
                const urgencyClass = getUrgencyClass(emp.retirementDate);
                
                return `
                    <div class="employee-item ${urgencyClass}">
                        <div class="employee-name">${emp.name}</div>
                        <div class="retirement-info">
                            ìƒë…„ì›”ì¼: ${formatDate(emp.birth)}<br>
                            í˜„ì¬ ë‚˜ì´: ${age}ì„¸<br>
                            ì •ë…„í‡´ì§ì¼: ${formatDate(emp.retirementDate)}
                        </div>
                        <button class="btn-danger" onclick="removeEmployee('${emp.name}', '${emp.birthDate}')" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;">ì‚­ì œ</button>
                    </div>
                `;
            }).join('');
        }
        
        function updateYearlySummary() {
            const container = document.getElementById('yearlyResults');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
            const yearGroups = {};
            employees.forEach(emp => {
                const year = emp.retirementYear;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(emp);
            });
            
            // ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedYears = Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b));
            
            container.innerHTML = sortedYears.map(year => {
                const yearEmployees = yearGroups[year].sort((a, b) => a.retirementDate - b.retirementDate);
                
                return `
                    <div class="year-item">
                        <div class="year-header">${year}ë…„ (${yearEmployees.length}ëª…)</div>
                        <div class="year-employees">
                            ${yearEmployees.map(emp => `
                                <div class="year-employee">
                                    <strong>${emp.name}</strong> - ${formatDate(emp.retirementDate)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function removeEmployee(name, birthDate) {
            if (confirm(`${name} ì§ì› ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                employees = employees.filter(emp => !(emp.name === name && emp.birthDate === birthDate));
                updateDisplay();
            }
        }
        
        // ì—”í„° í‚¤ ì…ë ¥ ì²˜ë¦¬
        document.getElementById('employeeName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('socialNumber').focus();
            }
        });
        
        document.getElementById('socialNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
        
        // ì£¼ë¯¼ë²ˆí˜¸ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ìƒë…„ì›”ì¼ ê³„ì‚°
        document.getElementById('socialNumber').addEventListener('input', function(e) {
            const socialNumber = e.target.value.trim();
            if (socialNumber.length === 6) {
                const parsedBirthDate = parseSocialNumber(socialNumber);
                if (parsedBirthDate) {
                    document.getElementById('birthDate').value = parsedBirthDate;
                }
            }
        });
        
        // ìƒë…„ì›”ì¼ ì§ì ‘ ì…ë ¥ ì‹œ ì£¼ë¯¼ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('birthDate').addEventListener('input', function(e) {
            if (e.target.value) {
                document.getElementById('socialNumber').value = '';
            }
        });
        
        document.getElementById('birthDate').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
    </script>
</body>
</html>