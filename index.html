<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정년퇴직 관리 시스템</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .input-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        input[type="text"], input[type="date"], input[type="file"] {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="file"]:focus {
            border-color: #3498db;
            outline: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        .employee-list, .yearly-summary {
            background: white;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            overflow: hidden;
        }
        .section-header {
            background: #34495e;
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
        }
        .employee-item, .year-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s;
        }
        .employee-item:hover, .year-item:hover {
            background: #f8f9fa;
        }
        .employee-item:last-child, .year-item:last-child {
            border-bottom: none;
        }
        .employee-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        .retirement-info {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .year-header {
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .year-employees {
            margin-left: 15px;
        }
        .year-employee {
            margin: 5px 0;
            padding: 5px 0;
        }
        .urgent {
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
        }
        .soon {
            background: #fff8e1;
            border-left: 4px solid #f39c12;
        }
        .normal {
            background: #f0f9ff;
            border-left: 4px solid #3498db;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        .preview-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .preview-header {
            background: #34495e;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preview-header h3 {
            margin: 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .preview-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .preview-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>정년퇴직 관리 시스템</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
            근로기준법 제19조에 따른 법정 정년 60세 기준<br>
            <small style="color: #95a5a6;">* 정년퇴직일: 생일이 속한 달의 말일</small>
        </p>
        
        <div style="text-align: center; margin-bottom: 20px; font-size: 12px; color: #95a5a6;">
            © 2025 Sungrak Church Office. All rights reserved.
        </div>
        
        <div class="input-section">
            <h3>직원 정보 입력</h3>
            <div class="form-row">
                <input type="text" id="employeeName" placeholder="직원 이름" />
                <input type="text" id="socialNumber" placeholder="주민번호 앞 6자리 (YYMMDD)" maxlength="6" />
                <input type="date" id="birthDate" placeholder="또는 생년월일 직접 입력" />
                <button onclick="addEmployee()">추가</button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                * 주민번호 앞 6자리 입력 시 생년월일이 자동 계산됩니다 (예: 640315 → 1964-03-15)
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #bdc3c7;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">엑셀 파일 가져오기</h4>
                <div class="form-row">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="flex: 2;" />
                    <button onclick="importExcel()">파일 가져오기</button>
                    <button onclick="downloadTemplate()" style="background: #27ae60;">템플릿 다운로드</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                    * 엑셀 파일 형식: A열(이름), B열(생년월일 또는 주민번호) | 다양한 형식 지원: YYYY-MM-DD, 주민번호 13자리, 주민번호 앞 6자리
                </div>
            </div>
        </div>

        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">총 직원 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="thisYearRetirement">0</div>
                <div class="stat-label">올해 정년퇴직</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="nextYearRetirement">0</div>
                <div class="stat-label">내년 정년퇴직</div>
            </div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <div class="export-section">
                <h3 style="margin-top: 0; color: #2c3e50;">데이터 내보내기</h3>
                <div class="form-row">
                    <button onclick="previewExport('all')" style="background: #27ae60;">전체 데이터 미리보기</button>
                    <button onclick="previewExport('thisYear')" style="background: #e74c3c;">올해 정년퇴직자 미리보기</button>
                    <button onclick="previewExport('nextYear')" style="background: #f39c12;">내년 정년퇴직자 미리보기</button>
                    <button onclick="previewYearlySummary()" style="background: #9b59b6;">연도별 인원 미리보기</button>
                </div>
            </div>
        </div>

        <!-- 미리보기 모달 -->
        <div class="preview-modal" id="previewModal">
            <div class="preview-content">
                <div class="preview-header">
                    <h3 id="previewTitle">데이터 미리보기</h3>
                    <button class="close-btn" onclick="closePreview()">&times;</button>
                </div>
                <div class="preview-body" id="previewBody">
                    <!-- 미리보기 내용이 여기에 표시됩니다 -->
                </div>
                <div class="preview-footer">
                    <button onclick="closePreview()" style="background: #95a5a6;">취소</button>
                    <button id="downloadBtn" onclick="confirmDownload()" style="background: #27ae60;">엑셀 다운로드</button>
                </div>
            </div>
        </div>

        <div class="results" id="resultsSection" style="display: none;">
            <div class="employee-list">
                <div class="section-header">직원별 정년퇴직 정보</div>
                <div id="employeeResults"></div>
            </div>
            
            <div class="yearly-summary">
                <div class="section-header">연도별 정년퇴직 예정자</div>
                <div id="yearlyResults"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let employees = [];
        const RETIREMENT_AGE = 60;
        
        function parseVariousDateFormats(input) {
            if (!input) return null;
            
            const inputStr = String(input).trim();
            
            // 1. 이미 YYYY-MM-DD 형식인 경우
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (dateRegex.test(inputStr)) {
                const testDate = new Date(inputStr);
                if (!isNaN(testDate.getTime())) {
                    return inputStr;
                }
            }
            
            // 2. 주민번호 13자리 (123456-1234567 또는 1234561234567)
            const fullSocialRegex = /^(\d{6})[-]?\d{7}$/;
            const fullSocialMatch = inputStr.match(fullSocialRegex);
            if (fullSocialMatch) {
                return parseSocialNumber(fullSocialMatch[1]);
            }
            
            // 3. 주민번호 앞 6자리만 (123456)
            const shortSocialRegex = /^\d{6}$/;
            if (shortSocialRegex.test(inputStr)) {
                return parseSocialNumber(inputStr);
            }
            
            // 4. 엑셀 시리얼 날짜 (숫자)
            if (typeof input === 'number' && input > 0) {
                const excelEpoch = new Date(1900, 0, 1);
                const birth = new Date(excelEpoch.getTime() + (input - 2) * 86400000);
                if (!isNaN(birth.getTime())) {
                    return birth.toISOString().split('T')[0];
                }
            }
            
            // 5. Date 객체인 경우
            if (input instanceof Date && !isNaN(input.getTime())) {
                return input.toISOString().split('T')[0];
            }
            
            return null;
        }
        
        function parseSocialNumber(socialNumber) {
            if (!socialNumber || socialNumber.length !== 6) {
                return null;
            }
            
            // 숫자만 있는지 확인
            if (!/^\d{6}$/.test(socialNumber)) {
                return null;
            }
            
            const year = parseInt(socialNumber.substring(0, 2));
            const month = parseInt(socialNumber.substring(2, 4));
            const day = parseInt(socialNumber.substring(4, 6));
            
            // 월과 일 유효성 검사
            if (month < 1 || month > 12 || day < 1 || day > 31) {
                return null;
            }
            
            // 년도 계산 (일반적으로 00-30은 2000년대, 31-99는 1900년대로 처리)
            let fullYear;
            if (year <= 30) {
                fullYear = 2000 + year;
            } else {
                fullYear = 1900 + year;
            }
            
            // 날짜 유효성 최종 검사
            const testDate = new Date(fullYear, month - 1, day);
            if (testDate.getFullYear() !== fullYear || 
                testDate.getMonth() !== month - 1 || 
                testDate.getDate() !== day) {
                return null;
            }
            
            return `${fullYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
        
        function calculateRetirementDate(birthDate) {
            const retirement = new Date(birthDate);
            retirement.setFullYear(retirement.getFullYear() + RETIREMENT_AGE);
            
            // 생일이 속한 달의 말일로 설정
            const year = retirement.getFullYear();
            const month = retirement.getMonth();
            
            // 다음 달의 첫째 날에서 하루를 빼면 현재 달의 마지막 날
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            return lastDayOfMonth;
        }
        
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const socialNumber = document.getElementById('socialNumber').value.trim();
            let birthDate = document.getElementById('birthDate').value;
            
            if (!name) {
                alert('직원 이름을 입력해주세요.');
                return;
            }
            
            // 주민번호가 입력된 경우 생년월일 자동 계산
            if (socialNumber) {
                const parsedBirthDate = parseSocialNumber(socialNumber);
                if (!parsedBirthDate) {
                    alert('올바른 주민번호 앞 6자리를 입력해주세요. (예: 640315)');
                    return;
                }
                birthDate = parsedBirthDate;
                // 계산된 생년월일을 화면에 표시
                document.getElementById('birthDate').value = birthDate;
            }
            
            if (!birthDate) {
                alert('주민번호 앞 6자리 또는 생년월일을 입력해주세요.');
                return;
            }
            
            // 중복 확인
            if (employees.some(emp => emp.name === name && emp.birthDate === birthDate)) {
                alert('이미 등록된 직원입니다.');
                return;
            }
            
            const birth = new Date(birthDate);
            const retirementDate = calculateRetirementDate(birth);
            
            employees.push({
                name: name,
                birthDate: birthDate,
                birth: birth,
                retirementDate: retirementDate,
                retirementYear: retirementDate.getFullYear()
            });
            
            // 입력 필드 초기화
            document.getElementById('employeeName').value = '';
            document.getElementById('socialNumber').value = '';
            document.getElementById('birthDate').value = '';
            
            updateDisplay();
        }
        
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('엑셀 파일을 선택해주세요.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let importCount = 0;
                    let skipCount = 0;
                    let errorCount = 0;
                    
                    // 첫 번째 행은 헤더로 건너뛰기
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0] || !row[1]) continue; // 빈 행 건너뛰기
                        
                        const name = String(row[0]).trim();
                        const dateInput = row[1];
                        
                        // 다양한 형식의 날짜/주민번호 처리
                        const birthDateStr = parseVariousDateFormats(dateInput);
                        
                        if (!birthDateStr) {
                            console.error(`날짜 변환 실패: ${name} - ${dateInput}`);
                            errorCount++;
                            continue;
                        }
                        
                        // 중복 확인
                        if (employees.some(emp => emp.name === name && emp.birthDate === birthDateStr)) {
                            skipCount++;
                            continue;
                        }
                        
                        // 유효한 날짜인지 확인
                        const birth = new Date(birthDateStr);
                        if (isNaN(birth.getTime())) {
                            errorCount++;
                            continue;
                        }
                        
                        const retirementDate = calculateRetirementDate(birth);
                        
                        employees.push({
                            name: name,
                            birthDate: birthDateStr,
                            birth: birth,
                            retirementDate: retirementDate,
                            retirementYear: retirementDate.getFullYear()
                        });
                        
                        importCount++;
                    }
                    
                    // 결과 메시지
                    let message = `가져오기 완료!\n`;
                    message += `- 신규 등록: ${importCount}명\n`;
                    if (skipCount > 0) message += `- 중복 건너뛰기: ${skipCount}명\n`;
                    if (errorCount > 0) message += `- 오류 건너뛰기: ${errorCount}명\n`;
                    
                    alert(message);
                    
                    // 파일 입력 초기화
                    fileInput.value = '';
                    
                    updateDisplay();
                    
                } catch (error) {
                    console.error('파일 처리 오류:', error);
                    alert('엑셀 파일을 읽는 중 오류가 발생했습니다.\n파일 형식을 확인해주세요.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function downloadTemplate() {
            // 템플릿 데이터 생성
            const templateData = [
                ['이름', '생년월일 또는 주민번호'],
                ['홍길동', '1964-03-15'],
                ['김철수', '650722-1234567'],
                ['이영희', '661203'],
                ['박민수', '1975-08-10']
            ];
            
            // 워크북 생성
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // 열 너비 설정
            ws['!cols'] = [
                {wch: 15}, // 이름 열
                {wch: 20}  // 생년월일/주민번호 열
            ];
            
            // 헤더 스타일 적용 (간단한 방법)
            XLSX.utils.book_append_sheet(wb, ws, '직원정보');
            
            // 파일 다운로드
            XLSX.writeFile(wb, '직원정보_템플릿.xlsx');
        }
        
        let currentExportData = null;
        let currentExportType = null;
        let currentFileName = '';
        
        function previewExport(type) {
            if (employees.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            let filteredEmployees = [];
            let title = '';
            const currentYear = new Date().getFullYear();
            
            switch(type) {
                case 'all':
                    filteredEmployees = [...employees];
                    title = '전체 직원 정년퇴직 정보';
                    currentFileName = '전체_직원_정년퇴직_정보';
                    break;
                case 'thisYear':
                    filteredEmployees = employees.filter(emp => emp.retirementYear === currentYear);
                    title = `${currentYear}년 정년퇴직 예정자`;
                    currentFileName = `${currentYear}년_정년퇴직_예정자`;
                    break;
                case 'nextYear':
                    filteredEmployees = employees.filter(emp => emp.retirementYear === currentYear + 1);
                    title = `${currentYear + 1}년 정년퇴직 예정자`;
                    currentFileName = `${currentYear + 1}년_정년퇴직_예정자`;
                    break;
            }
            
            if (filteredEmployees.length === 0) {
                alert('해당 조건에 맞는 데이터가 없습니다.');
                return;
            }
            
            // 정년퇴직일 기준으로 정렬
            filteredEmployees.sort((a, b) => a.retirementDate - b.retirementDate);
            
            // 엑셀 데이터 구성
            const excelData = [
                ['이름', '생년월일', '현재나이', '정년퇴직일', '정년퇴직년도', '남은일수']
            ];
            
            const today = new Date();
            filteredEmployees.forEach(emp => {
                const age = today.getFullYear() - emp.birth.getFullYear();
                const remainingDays = Math.ceil((emp.retirementDate - today) / (1000 * 60 * 60 * 24));
                
                excelData.push([
                    emp.name,
                    emp.birthDate,
                    age + '세',
                    emp.retirementDate.toISOString().split('T')[0],
                    emp.retirementYear,
                    remainingDays > 0 ? remainingDays + '일' : '퇴직완료'
                ]);
            });
            
            currentExportData = excelData;
            currentExportType = 'normal';
            showPreview(title, excelData);
        }
        
        function previewYearlySummary() {
            if (employees.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            // 연도별로 그룹화
            const yearGroups = {};
            employees.forEach(emp => {
                const year = emp.retirementYear;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(emp);
            });
            
            const sortedYears = Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b));
            
            // 연도별 인원 데이터 구성
            const summaryData = [
                ['정년퇴직년도', '퇴직예정인원']
            ];
            
            sortedYears.forEach(year => {
                const count = yearGroups[year].length;
                summaryData.push([year + '년', count + '명']);
            });
            
            currentExportData = { summaryData, yearGroups, sortedYears };
            currentExportType = 'summary';
            currentFileName = '연도별_정년퇴직_인원';
            showPreview('연도별 정년퇴직 인원', summaryData);
        }
        
        function showPreview(title, data) {
            document.getElementById('previewTitle').textContent = title + ' 미리보기';
            
            let html = `
                <div style="margin-bottom: 15px; color: #7f8c8d;">
                    총 ${data.length - 1}건의 데이터 (제목행 제외)
                </div>
                <table class="preview-table">
            `;
            
            data.forEach((row, index) => {
                html += '<tr>';
                row.forEach(cell => {
                    const tag = index === 0 ? 'th' : 'td';
                    html += `<${tag}>${cell}</${tag}>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            if (currentExportType === 'summary') {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px;">
                        <strong>💡 참고사항:</strong><br>
                        연도별 인원 다운로드 시 위 요약표와 함께 각 연도별 상세 시트가 포함됩니다.
                    </div>
                `;
            }
            
            document.getElementById('previewBody').innerHTML = html;
            document.getElementById('previewModal').style.display = 'block';
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            currentExportData = null;
            currentExportType = null;
            currentFileName = '';
        }
        
        function confirmDownload() {
            if (!currentExportData || !currentExportType) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }
            
            if (currentExportType === 'normal') {
                downloadNormalExcel();
            } else if (currentExportType === 'summary') {
                downloadSummaryExcel();
            }
            
            closePreview();
        }
        
        function downloadNormalExcel() {
            // 워크북 생성
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(currentExportData);
            
            // 열 너비 설정
            ws['!cols'] = [
                {wch: 12}, // 이름
                {wch: 12}, // 생년월일
                {wch: 10}, // 현재나이
                {wch: 12}, // 정년퇴직일
                {wch: 12}, // 정년퇴직년도
                {wch: 10}  // 남은일수
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '정년퇴직정보');
            
            // 파일 다운로드
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `${currentFileName}_${timestamp}.xlsx`);
        }
        
        function downloadSummaryExcel() {
            const { summaryData, yearGroups, sortedYears } = currentExportData;
            
            // 워크북 생성
            const wb = XLSX.utils.book_new();
            
            // 요약 시트 생성
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{wch: 15}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, summaryWs, '연도별인원');
            
            // 각 연도별 상세 시트 생성
            sortedYears.forEach(year => {
                const yearEmployees = yearGroups[year].sort((a, b) => a.retirementDate - b.retirementDate);
                const yearData = [
                    ['이름', '생년월일', '정년퇴직일', '현재나이']
                ];
                
                const today = new Date();
                yearEmployees.forEach(emp => {
                    const age = today.getFullYear() - emp.birth.getFullYear();
                    yearData.push([
                        emp.name,
                        emp.birthDate,
                        emp.retirementDate.toISOString().split('T')[0],
                        age + '세'
                    ]);
                });
                
                const yearWs = XLSX.utils.aoa_to_sheet(yearData);
                yearWs['!cols'] = [{wch: 12}, {wch: 12}, {wch: 12}, {wch: 10}];
                XLSX.utils.book_append_sheet(wb, yearWs, year + '년');
            });
            
            // 파일 다운로드
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `${currentFileName}_${timestamp}.xlsx`);
        }
        function exportToExcel(type) {
            // 기존 함수는 미리보기 기능으로 대체되었습니다
            // 호환성을 위해 남겨둡니다
            previewExport(type);
        }
        
        function exportYearlySummary() {
            // 기존 함수는 미리보기 기능으로 대체되었습니다
            // 호환성을 위해 남겨둡니다
            previewYearlySummary();
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function getUrgencyClass(retirementDate) {
            const today = new Date();
            const daysDiff = Math.ceil((retirementDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 365) return 'urgent';
            if (daysDiff <= 730) return 'soon';
            return 'normal';
        }
        
        function updateDisplay() {
            if (employees.length === 0) {
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
                return;
            }
            
            document.getElementById('resultsSection').style.display = 'grid';
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('exportSection').style.display = 'block';
            
            updateStats();
            updateEmployeeList();
            updateYearlySummary();
        }
        
        function updateStats() {
            const currentYear = new Date().getFullYear();
            const thisYear = employees.filter(emp => emp.retirementYear === currentYear).length;
            const nextYear = employees.filter(emp => emp.retirementYear === currentYear + 1).length;
            
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('thisYearRetirement').textContent = thisYear;
            document.getElementById('nextYearRetirement').textContent = nextYear;
        }
        
        function updateEmployeeList() {
            const container = document.getElementById('employeeResults');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state">등록된 직원이 없습니다.</div>';
                return;
            }
            
            // 정년퇴직일 기준으로 정렬
            const sortedEmployees = [...employees].sort((a, b) => a.retirementDate - b.retirementDate);
            
            container.innerHTML = sortedEmployees.map(emp => {
                const age = new Date().getFullYear() - emp.birth.getFullYear();
                const urgencyClass = getUrgencyClass(emp.retirementDate);
                
                return `
                    <div class="employee-item ${urgencyClass}">
                        <div class="employee-name">${emp.name}</div>
                        <div class="retirement-info">
                            생년월일: ${formatDate(emp.birth)}<br>
                            현재 나이: ${age}세<br>
                            정년퇴직일: ${formatDate(emp.retirementDate)}
                        </div>
                        <button class="btn-danger" onclick="removeEmployee('${emp.name}', '${emp.birthDate}')" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;">삭제</button>
                    </div>
                `;
            }).join('');
        }
        
        function updateYearlySummary() {
            const container = document.getElementById('yearlyResults');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state">등록된 직원이 없습니다.</div>';
                return;
            }
            
            // 연도별로 그룹화
            const yearGroups = {};
            employees.forEach(emp => {
                const year = emp.retirementYear;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(emp);
            });
            
            // 연도 순으로 정렬
            const sortedYears = Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b));
            
            container.innerHTML = sortedYears.map(year => {
                const yearEmployees = yearGroups[year].sort((a, b) => a.retirementDate - b.retirementDate);
                
                return `
                    <div class="year-item">
                        <div class="year-header">${year}년 (${yearEmployees.length}명)</div>
                        <div class="year-employees">
                            ${yearEmployees.map(emp => `
                                <div class="year-employee">
                                    <strong>${emp.name}</strong> - ${formatDate(emp.retirementDate)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function removeEmployee(name, birthDate) {
            if (confirm(`${name} 직원 정보를 삭제하시겠습니까?`)) {
                employees = employees.filter(emp => !(emp.name === name && emp.birthDate === birthDate));
                updateDisplay();
            }
        }
        
        // 엔터 키 입력 처리
        document.getElementById('employeeName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('socialNumber').focus();
            }
        });
        
        document.getElementById('socialNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
        
        // 주민번호 입력 시 실시간 생년월일 계산
        document.getElementById('socialNumber').addEventListener('input', function(e) {
            const socialNumber = e.target.value.trim();
            if (socialNumber.length === 6) {
                const parsedBirthDate = parseSocialNumber(socialNumber);
                if (parsedBirthDate) {
                    document.getElementById('birthDate').value = parsedBirthDate;
                }
            }
        });
        
        // 생년월일 직접 입력 시 주민번호 필드 초기화
        document.getElementById('birthDate').addEventListener('input', function(e) {
            if (e.target.value) {
                document.getElementById('socialNumber').value = '';
            }
        });
        
        document.getElementById('birthDate').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
    </script>
</body>
</html>